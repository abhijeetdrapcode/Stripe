<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Payment</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; }
      #payment-form { max-width: 400px; margin: 0 auto; }
      #payment-element { margin-bottom: 20px; }
      button { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; }
      #error-message { color: red; margin-top: 10px; }
    </style>
  </head>
  <body>
    <main>
      <h1>Payment</h1>
      <form id="payment-form">
        <div id="payment-element"></div>
        <button id="submit">Pay now</button>
        <div id="error-message"></div>
      </form>
    </main>
    <script>
      const stripe = Stripe('<%= publishableKey %>');
      let elements;

      document.addEventListener('DOMContentLoaded', initialize);
      document.querySelector("#payment-form").addEventListener("submit", handleSubmit);

      async function initialize() {
        try {

          let response = await fetch("http://localhost:3001/")
          if (!response.ok) {
            throw new Error('Failed to create payment intent');
          }
          
          const { clientSecret } = await response.json();

          const appearance = {
            theme: 'stripe',
          };
          
          elements = stripe.elements({ appearance, clientSecret });

          const paymentElement = elements.create("payment");
          paymentElement.mount("#payment-element");
        } catch (error) {
          console.error('Initialization error:', error);
          showError('Failed to initialize payment. Please try again.');
        }
      }

      async function handleSubmit(e) {
        e.preventDefault();
        setLoading(true);

        try {
          const { error } = await stripe.confirmPayment({
            elements,
            confirmParams: {
              return_url: "http://localhost:3001/completion",
            },
          });

          if (error) {
            throw error;
          }
        } catch (error) {
          if (error.type === "card_error" || error.type === "validation_error") {
            showError(error.message);
          } else {
            showError("An unexpected error occurred.");
          }
        }

        setLoading(false);
      }

      function showError(message) {
        const errorDiv = document.querySelector("#error-message");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 4000);
      }

      function setLoading(isLoading) {
        const submitButton = document.querySelector("#submit");
        submitButton.disabled = isLoading;
        submitButton.textContent = isLoading ? "Processing..." : "Pay now";
      }
    </script>
  </body>
</html>